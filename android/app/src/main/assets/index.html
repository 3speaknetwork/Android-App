<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="3Speak Acela" />
    <title>3Speak Acela</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <!-- <script src="./hive.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@hiveio/hive-js/dist/hive.min.js"></script>
    <script>
      function validateHiveKey(accountName, postingKey) {
        console.log("In here before async");
        hive.api
          .getAccountsAsync([accountName])
          .then(function (accounts) {
            console.log("In here after async");
            console.log("Accounts: ", accounts);
            const pubWif = accounts[0].posting.key_auths[0][0];
            console.log("PubWif: ", pubWif);
            const Valid = hive.auth.wifIsValid(postingKey, pubWif);
            console.log(`is valid ${Valid}`);
            var result = {
              type: "validateHiveKey",
              valid: Valid,
              accountName: accountName,
              postingKey: postingKey,
              error: "",
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          })
          .catch(function (err) {
            console.log("Error: ", err);
            var result = {
              type: "validateHiveKey",
              valid: false,
              accountName: accountName,
              postingKey: postingKey,
              error: err.message,
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          });
      }

      function decryptMemo(accountName, postingKey, encrypted) {
        console.log("In here before async");
        hive.api
          .getAccountsAsync([accountName])
          .then(function (accounts) {
            console.log("In here after async");
            console.log("Accounts: ", accounts);
            const pubWif = accounts[0].posting.key_auths[0][0];
            console.log("PubWif: ", pubWif);
            const Valid = hive.auth.wifIsValid(postingKey, pubWif);
            console.log(`is valid ${Valid}`);
            let decrypted = hive.memo.decode(postingKey, encrypted);
            let result = {
              type: "decryptedMemo",
              accountName: accountName,
              decrypted: decrypted,
              error: "",
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          })
          .catch(function (err) {
            console.log("Error: ", err);
            let result = {
              type: "decryptedMemo",
              accountName: accountName,
              decrypted: "",
              error: err.message,
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          });
      }

      function postVideo(params, postingKey) {
        console.log(`params in string ${params}`);
        const utf8String = btoa(params);
        console.log(`utf8String in json ${JSON.parse(utf8String)}`);
        const ops = JSON.parse(utf8String);
        async function tryPublish(operations, key) {
          try {
            return hive.broadcast.sendAsync({ operations }, { posting: key });
          } catch (e) {
            return e;
          }
        }
        tryPublish(ops, postingKey)
          .then((result) => {
            var newResult = {
              type: "postVideo",
              valid: true,
              error: JSON.stringify(result),
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(newResult));
          })
          .catch((error) => {
            var result = {
              type: "postVideo",
              valid: false,
              error: error.message,
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          });
      }
    </script>
  </body>
</html>
