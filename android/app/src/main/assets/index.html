<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="3Speak Acela" />
    <title>3Speak Acela</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <!-- <script src="./hive.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/@hiveio/hive-js/dist/hive.min.js"></script>
    <script>
      function validateHiveKey(accountName, postingKey) {
        console.log("In here before async");
        hive.api
          .getAccountsAsync([accountName])
          .then(function (accounts) {
            console.log("In here after async");
            console.log("Accounts: ", accounts);
            const pubWif = accounts[0].posting.key_auths[0][0];
            console.log("PubWif: ", pubWif);
            const Valid = hive.auth.wifIsValid(postingKey, pubWif);
            console.log(`is valid ${Valid}`);
            var result = {
              type: "validateHiveKey",
              valid: Valid,
              accountName: accountName,
              error: "",
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          })
          .catch(function (err) {
            console.log("Error: ", err);
            var result = {
              type: "validateHiveKey",
              valid: false,
              accountName: accountName,
              error: err.message,
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          });
      }

      function decryptMemo(accountName, postingKey, encrypted) {
        console.log("In here before async");
        hive.api
          .getAccountsAsync([accountName])
          .then(function (accounts) {
            console.log("In here after async");
            console.log("Accounts: ", accounts);
            const pubWif = accounts[0].posting.key_auths[0][0];
            console.log("PubWif: ", pubWif);
            const Valid = hive.auth.wifIsValid(postingKey, pubWif);
            console.log(`is valid ${Valid}`);
            let decrypted = hive.memo.decode(postingKey, encrypted);
            let result = {
              type: "decryptedMemo",
              accountName: accountName,
              decrypted: decrypted,
              error: "",
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          })
          .catch(function (err) {
            console.log("Error: ", err);
            let result = {
              type: "decryptedMemo",
              accountName: accountName,
              decrypted: "",
              error: err.message,
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          });
      }

      function postVideo(data, postingKey) {
        console.log(`Response received from server: ${data}`);
        const result = JSON.parse(data).data;
        const json_metadata = JSON.stringify(result.json_metadata);
        const comment = { ...result.comment, json_metadata: json_metadata };
        const newExtensions = result.extensions.sort((a, b) => {
          let fa = a.account.toLowerCase(),
            fb = b.account.toLowerCase();
          if (fa < fb) return -1;
          if (fa > fb) return 1;
          return 0;
        });
        const comment_options = {
          ...result.comment_options,
          extensions: [[0, { beneficiaries: newExtensions }]],
        };
        const json = JSON.stringify(result.custom_json.json);
        const custom_json = { ...result.custom_json, json: json };
        const ops = [
          ["comment", comment],
          ["comment_options", comment_options],
          ["custom_json", custom_json],
        ];
				console.log(`ops is ${ops}`);
        async function tryPublish(operations, key) {
          try {
            return hive.broadcast.sendAsync({ operations }, { posting: key });
          } catch (e) {
            return e;
          }
        }
        tryPublish(ops, postingKey)
          .then((result) => {
            var newResult = {
              type: "postVideo",
              valid: true,
              error: JSON.stringify(result),
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(newResult));
          })
          .catch((error) => {
            console.error(error);
            var result = {
              type: "postVideo",
              valid: false,
              error: error.message,
            };
            // window.webkit.messageHandlers.acela.postMessage(result);
            Android.postMessage(JSON.stringify(result));
          });
      }
    </script>
  </body>
</html>
